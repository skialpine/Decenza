name: macOS Build

on:
  # Manual trigger from GitHub UI or API
  workflow_dispatch:
    inputs:
      upload_to_release:
        description: 'Upload to latest GitHub release'
        required: true
        default: 'true'
        type: boolean

  # Or trigger on version tags
  push:
    tags:
      - 'v*'

jobs:
  build-macos:
    runs-on: macos-15
    permissions:
      contents: write  # Required for uploading to releases

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for version tags

      - name: Get version info
        id: version
        run: |
          VERSION=$(grep 'project.*VERSION' CMakeLists.txt | sed 's/.*VERSION \([0-9]*\.[0-9]*\.[0-9]*\).*/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.10.1'
          target: 'desktop'
          arch: 'clang_64'
          modules: 'qtquick3d qtshadertools qtcharts qtconnectivity qtmultimedia qtpositioning qtspeech qtwebsockets qtwebengine'
          cache: true
          cache-key-prefix: 'qt-macos-v2'

      - name: Configure CMake
        run: |
          mkdir -p build/macos
          cd build/macos
          $QT_ROOT_DIR/bin/qt-cmake ../.. -G Xcode \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=12.0 \
            -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64" \
            -DCMAKE_POLICY_VERSION_MINIMUM=3.5

      - name: Build Release
        run: |
          cd build/macos
          cmake --build . --config Release --parallel

      - name: Bundle Qt frameworks
        run: |
          APP_PATH="build/macos/Release/Decenza_DE1.app"
          echo "Running macdeployqt on: $APP_PATH"

          # macdeployqt bundles Qt frameworks and fixes library paths
          $QT_ROOT_DIR/bin/macdeployqt "$APP_PATH" -qmldir=qml -verbose=2

          echo "Bundled frameworks:"
          ls -la "$APP_PATH/Contents/Frameworks/" | head -20

      - name: Import Code Signing Certificate
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate
          echo "$MACOS_CERTIFICATE" | base64 --decode > certificate.p12
          security import certificate.p12 -P "$MACOS_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"

          # Allow codesign to access the keychain
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          rm certificate.p12

      - name: Code Sign App
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          APP_PATH="build/macos/Release/Decenza_DE1.app"
          IDENTITY="Developer ID Application: Michael Nesbitt ($APPLE_TEAM_ID)"

          echo "Signing with identity: $IDENTITY"

          # Sign all frameworks and dylibs first (deep signing)
          find "$APP_PATH/Contents/Frameworks" -type f \( -name "*.dylib" -o -name "*.framework" \) -exec \
            codesign --force --options runtime --timestamp --sign "$IDENTITY" {} \; 2>/dev/null || true

          # Sign the main executable
          codesign --force --options runtime --timestamp --sign "$IDENTITY" "$APP_PATH/Contents/MacOS/Decenza_DE1"

          # Sign the entire app bundle
          codesign --force --deep --options runtime --timestamp --sign "$IDENTITY" "$APP_PATH"

          # Verify
          codesign --verify --deep --strict --verbose=2 "$APP_PATH"
          echo "Code signing complete"

      - name: Create DMG
        run: |
          VERSION=${{ steps.version.outputs.version }}
          DMG_NAME="Decenza_DE1_v${VERSION}_macos.dmg"

          # Find the built app (named Decenza_DE1.app)
          APP_PATH="build/macos/Release/Decenza_DE1.app"
          echo "Looking for app at: $APP_PATH"

          if [ ! -d "$APP_PATH" ]; then
            echo "ERROR: Could not find $APP_PATH"
            find build/macos -name "*.app" -type d
            exit 1
          fi

          # Create a temporary directory for DMG contents
          mkdir -p dmg_contents
          cp -R "$APP_PATH" "dmg_contents/Decenza DE1.app"

          # Create Applications symlink
          ln -s /Applications dmg_contents/Applications

          # Create DMG
          hdiutil create -volname "Decenza DE1" \
            -srcfolder dmg_contents \
            -ov -format UDZO \
            "$DMG_NAME"

          echo "Created: $DMG_NAME"
          ls -la "$DMG_NAME"

      - name: Notarize DMG
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          VERSION=${{ steps.version.outputs.version }}
          DMG_NAME="Decenza_DE1_v${VERSION}_macos.dmg"

          echo "Submitting for notarization..."
          xcrun notarytool submit "$DMG_NAME" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_ID_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait

          echo "Stapling notarization ticket..."
          xcrun stapler staple "$DMG_NAME"

          echo "Notarization complete"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Decenza_DE1-macOS
          path: Decenza_DE1_v*.dmg
          retention-days: 30

      - name: Upload to GitHub Release
        if: ${{ inputs.upload_to_release == true || startsWith(github.ref, 'refs/tags/v') }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION=${{ steps.version.outputs.version }}
          DMG_NAME="Decenza_DE1_v${VERSION}_macos.dmg"

          # Find the release (by tag or latest)
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"
          else
            TAG="v${VERSION}"
          fi

          echo "Uploading to release: $TAG"
          gh release upload "$TAG" "$DMG_NAME" --clobber || echo "Release $TAG not found, skipping upload"
