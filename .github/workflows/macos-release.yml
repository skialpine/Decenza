name: macOS Build

on:
  # Manual trigger from GitHub UI or API
  workflow_dispatch:
    inputs:
      upload_to_release:
        description: 'Upload to latest GitHub release'
        required: true
        default: 'false'
        type: boolean

  # Or trigger on version tags
  push:
    tags:
      - 'v*'

jobs:
  build-macos:
    runs-on: macos-15
    permissions:
      contents: write  # Required for uploading to releases

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for version tags

      - name: Get version info
        id: version
        run: |
          VERSION=$(grep 'project.*VERSION' CMakeLists.txt | sed 's/.*VERSION \([0-9]*\.[0-9]*\.[0-9]*\).*/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.10.1'
          target: 'desktop'
          arch: 'clang_64'
          modules: 'qtquick3d qtshadertools qtcharts qtconnectivity qtmultimedia qtpositioning qtspeech qtwebsockets qtwebengine'
          cache: true
          cache-key-prefix: 'qt-macos-v2'

      - name: Configure CMake
        run: |
          mkdir -p build/macos
          cd build/macos
          $QT_ROOT_DIR/bin/qt-cmake ../.. -G Xcode \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=12.0 \
            -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64" \
            -DCMAKE_POLICY_VERSION_MINIMUM=3.5

      - name: Build Release
        run: |
          cd build/macos
          cmake --build . --config Release --parallel

      - name: Bundle Qt frameworks
        run: |
          APP_PATH="build/macos/Release/Decenza_DE1.app"
          echo "Running macdeployqt on: $APP_PATH"

          # macdeployqt bundles Qt frameworks and fixes library paths
          $QT_ROOT_DIR/bin/macdeployqt "$APP_PATH" -qmldir=qml -verbose=2

          echo "Bundled frameworks:"
          ls -la "$APP_PATH/Contents/Frameworks/" | head -20

      - name: Create DMG
        run: |
          VERSION=${{ steps.version.outputs.version }}
          DMG_NAME="Decenza_DE1_v${VERSION}_macos.dmg"

          # Find the built app (named Decenza_DE1.app)
          APP_PATH="build/macos/Release/Decenza_DE1.app"
          echo "Looking for app at: $APP_PATH"

          if [ ! -d "$APP_PATH" ]; then
            echo "ERROR: Could not find $APP_PATH"
            find build/macos -name "*.app" -type d
            exit 1
          fi

          # Create a temporary directory for DMG contents
          mkdir -p dmg_contents
          cp -R "$APP_PATH" "dmg_contents/Decenza DE1.app"

          # Create Applications symlink
          ln -s /Applications dmg_contents/Applications

          # Create DMG
          hdiutil create -volname "Decenza DE1" \
            -srcfolder dmg_contents \
            -ov -format UDZO \
            "$DMG_NAME"

          echo "Created: $DMG_NAME"
          ls -la "$DMG_NAME"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Decenza_DE1-macOS
          path: Decenza_DE1_v*.dmg
          retention-days: 30

      - name: Upload to GitHub Release
        if: ${{ inputs.upload_to_release == true || startsWith(github.ref, 'refs/tags/v') }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION=${{ steps.version.outputs.version }}
          DMG_NAME="Decenza_DE1_v${VERSION}_macos.dmg"

          # Find the release (by tag or latest)
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"
          else
            TAG="v${VERSION}"
          fi

          echo "Uploading to release: $TAG"
          gh release upload "$TAG" "$DMG_NAME" --clobber || echo "Release $TAG not found, skipping upload"
