name: Linux AppImage Build

on:
  # Manual trigger from GitHub UI or API
  workflow_dispatch:
    inputs:
      upload_to_release:
        description: 'Upload to GitHub Release'
        required: true
        default: 'true'
        type: boolean

  # Or trigger on version tags
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-linux:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for version tags

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            libgl1-mesa-dev \
            libxkbcommon-dev \
            libxkbcommon-x11-0 \
            libxcb-cursor0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-randr0 \
            libxcb-render-util0 \
            libxcb-shape0 \
            libxcb-xinerama0 \
            libxcb-xfixes0 \
            libpulse0 \
            libspeechd2 \
            fuse \
            libfuse2

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.10.2'
          target: 'desktop'
          arch: 'linux_gcc_64'
          modules: 'qtquick3d qtshadertools qtcharts qtconnectivity qtmultimedia qtpositioning qtspeech qtwebsockets'
          cache: true
          cache-key-prefix: 'qt-linux-v4'

      - name: Download linuxdeploy tools
        run: |
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          wget -q https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
          chmod +x linuxdeploy*.AppImage

      - name: Configure CMake
        run: |
          mkdir -p build
          cd build
          $QT_ROOT_DIR/bin/qt-cmake .. -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_POLICY_VERSION_MINIMUM=3.5

      - name: Build
        run: |
          cd build
          ninja -j$(nproc)

      - name: Get version
        id: version
        run: |
          VERSION=$(grep "project(Decenza_DE1 VERSION" CMakeLists.txt | sed 's/.*VERSION \([0-9.]*\).*/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Prepare AppDir
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          cp build/Decenza_DE1 AppDir/usr/bin/
          cp decenza.desktop AppDir/usr/share/applications/
          cp decenza.png AppDir/usr/share/icons/hicolor/256x256/apps/

      - name: Remove problematic Qt plugins
        run: |
          # Remove plugins with external dependencies not available in AppImage
          # Must be done after CMake but before linuxdeploy
          rm -f $QT_ROOT_DIR/plugins/imageformats/libqtiff.so
          rm -f $QT_ROOT_DIR/plugins/sqldrivers/libqsqlibase.so
          rm -f $QT_ROOT_DIR/plugins/sqldrivers/libqsqlpsql.so
          rm -f $QT_ROOT_DIR/plugins/sqldrivers/libqsqlmysql.so
          rm -f $QT_ROOT_DIR/plugins/sqldrivers/libqsqloci.so
          rm -f $QT_ROOT_DIR/plugins/sqldrivers/libqsqlodbc.so
          rm -f $QT_ROOT_DIR/plugins/sqldrivers/libqsqlmimer.so
          # Position plugin needs SerialPort which isn't installed
          rm -f $QT_ROOT_DIR/plugins/position/libqtposition_nmea.so

      - name: Create AppImage
        env:
          QMAKE: ${{ env.QT_ROOT_DIR }}/bin/qmake
          QML_SOURCES_PATHS: ${{ github.workspace }}/qml
        run: |
          ./linuxdeploy-x86_64.AppImage \
            --appdir AppDir \
            --plugin qt \
            --output appimage

      - name: Rename AppImage
        run: |
          mv Decenza_DE1-x86_64.AppImage Decenza_DE1_${{ steps.version.outputs.version }}-x86_64.AppImage

      - name: Upload AppImage as artifact
        uses: actions/upload-artifact@v4
        with:
          name: Decenza_DE1-Linux-x86_64
          path: Decenza_DE1_${{ steps.version.outputs.version }}-x86_64.AppImage
          retention-days: 30

      - name: Upload to GitHub Release
        if: startsWith(github.ref, 'refs/tags/v') || inputs.upload_to_release == true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the tag name (either from push or extract version)
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG_NAME="${{ github.ref_name }}"
          else
            TAG_NAME="v${{ steps.version.outputs.version }}"
          fi

          echo "Uploading to release: $TAG_NAME"

          # Check if release exists, create if not
          if ! gh release view "$TAG_NAME" > /dev/null 2>&1; then
            echo "Creating release $TAG_NAME"
            gh release create "$TAG_NAME" \
              --title "Decenza $TAG_NAME" \
              --generate-notes
          fi

          # Upload the AppImage
          gh release upload "$TAG_NAME" \
            "Decenza_DE1_${{ steps.version.outputs.version }}-x86_64.AppImage" \
            --clobber
